<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="logo192.png" />
    <title>React App</title>
  </head>

  <script src="/dist/subway.js"></script>

  <script>
    (function() {
      /*
      https://cqrs.nu/tutorial/cs/02-domain-logic
      COMMANDS ->         EVENTS (capture all that is to be persisted for the future)
      user-facing    /    domain-facing
      -------------------------------
      OpenTab ->          TabOpened  ->     TabNotOpen
      PlaceOrder ->       DrinksOrdered ->  TabNotOpen
      PlaceOrder ->       FoodOrdered ->    TabNotOpen
      // AmendOrder ->       DrinksCancelled
      // AmendOrder ->       FoodCancelled
      MarkDrinksServed -> DrinksServed ->   DrinksNotOutstanding
      // MarkFoodPrepared -> FoodPrepared
      MarkFoodServed ->   FoodServed ->     FoodNotOutstanding
      CloseTab ->         TabClosed -> .... OutStandingFood / TabNotOpen
      -------------------------------
      */
      // NOTE: event handlers: mutate VS immutable
      // NOTE E.g. aggregatePromotions: if food served with delay, apply discount
      // NOTE: proposal and patchState for mutable state
      // NOTE what happens if exception in EVENT runCommandHandlers? rollback event?
      // TODO 1 : aggregate 1. state 2. services
      // TODO 2 : call onError for COMMAND handlers exceptions
      const AGGREGATE = "TabAggregate";
      // const TabAggragate = {
      //   open: false,
      //   outstandingDrinks: [],
      //   outstandingDrinks: [],
      // }
      const CMD = {
        OPEN_TAB: "OpenTab",
        PLACE_ORDER: "PlaceOrder",
        MARK_DRINK_SERVED: "MarkDrinksServed",
        MARK_FOOD_SERVED: "MarkFoodServed",
        CLOSE_TAB: "CloseTab"
      };
      const EVT = {
        TAB_OPENED: "TabOpened",
        DRINKS_ORDERED: "DrinksOrdered",
        FOOD_ORDERED: "FoodOrdered",
        DRINK_SERVED: "DrinksServed",
        FOOD_SERVED: "FoodServed",
        TAB_CLOSED: "TabClosed"
      };

      const EX = {
        TAB_NOT_OPEN: "Tab is not open",
        DRINKS_NOT_OUTSTANDING: "No outstanding drinks for this tab",
        FOOD_NOT_OUTSTANDING: "No outstanding food for this tab"
      };

      Subway.createAggregate(AGGREGATE, { open: false, servedItemsValue: 0 });

      const tabAggregate = Subway.selectAggregate(AGGREGATE);

      tabAggregate.observeState({
        next: payload => {
          console.log(payload);
          setTimeout(() => {
            const el = document.querySelector("#root");
            el.innerHTML =
              el.innerHTML +
              "\n------------\n" +
              JSON.stringify(payload.nextState, null, 2);
          }, 0);
        }
      });

      tabAggregate.spy("*", {
        next: payload => {
          console.log(payload);
        }
      });

      // tabAggregate.spy(CMD.OPEN_TAB, {
      //   next: payload => {
      //     console.log("CMD.OPEN_TAB > ", payload);
      //   }
      // });
      // tabAggregate.spy(EVT.TAB_OPENED, {
      //   next: payload => {
      //     console.log("EVT.TAB_OPENED > ", payload);
      //   }
      // });
      // tabAggregate.spy(CMD.PLACE_ORDER, {
      //   next: payload => {
      //     console.log("CMD.PLACE_ORDER > ", payload);
      //   }
      // });
      // tabAggregate.spy(EVT.DRINKS_ORDERED, {
      //   next: payload => {
      //     console.log("EVT.DRINKS_ORDERED > ", payload);
      //   }
      // });
      // tabAggregate.spy(EVT.FOOD_ORDERED, {
      //   next: payload => {
      //     console.log("EVT.FOOD_ORDERED > ", payload);
      //   }
      // });
      // tabAggregate.spy(CMD.MARK_DRINK_SERVED, {
      //   next: payload => {
      //     console.log("CMD.MARK_DRINK_SERVED > ", payload);
      //   }
      // });
      // tabAggregate.spy(EVT.DRINK_SERVED, {
      //   next: payload => {
      //     console.log("EVT.DRINK_SERVED > ", payload);
      //   }
      // });
      // tabAggregate.spy(CMD.MARK_FOOD_SERVED, {
      //   next: payload => {
      //     console.log("CMD.MARK_FOOD_SERVED > ", payload);
      //   }
      // });
      // tabAggregate.spy(EVT.FOOD_SERVED, {
      //   next: payload => {
      //     console.log("EVT.FOOD_SERVED > ", payload);
      //   }
      // });
      // tabAggregate.spy(CMD.CLOSE_TAB, {
      //   next: payload => {
      //     console.log("CMD.CLOSE_TAB > ", payload);
      //   }
      // });
      // tabAggregate.spy(EVT.TAB_CLOSED, {
      //   next: payload => {
      //     console.log("EVT.TAB_CLOSED > ", payload);
      //   }
      // });

      tabAggregate.setCommandHandler(CMD.OPEN_TAB, (topicState, payload) => {
        return {
          events: [
            { id: EVT.TAB_OPENED, payload: { id: 0, table: 1, waiter: 1 } }
          ]
        };
      });

      tabAggregate.setEventHandler(EVT.TAB_OPENED, (topicState, payload) => {
        return {
          proposal: { open: true }
        };
      });

      tabAggregate.setCommandHandler(CMD.PLACE_ORDER, (topicState, payload) => {
        if (!topicState.open) throw Error(EX.TAB_NOT_OPEN);

        const drinkSample = payload.orderedItems.filter(i => i.isDrink);
        const foodSample = payload.orderedItems.filter(i => !i.isDrink);

        return {
          events: [
            { id: EVT.DRINKS_ORDERED, payload: drinkSample },
            { id: EVT.FOOD_ORDERED, payload: foodSample }
          ]
        };
      });

      tabAggregate.setEventHandler(
        EVT.DRINKS_ORDERED,
        (topicState, payload) => {
          return {
            proposal: {
              ...topicState, // TODO no, only partial
              outstandingDrinks: payload
            }
          };
        }
      );

      tabAggregate.setEventHandler(EVT.FOOD_ORDERED, (topicState, payload) => {
        return {
          proposal: {
            ...topicState, // TODO no, only partial
            outstandingFood: payload
          }
        };
      });

      tabAggregate.setCommandHandler(
        CMD.MARK_DRINK_SERVED,
        (topicState, payload) => {
          if (!topicState.open) throw Error(EX.TAB_NOT_OPEN);

          if (topicState.outstandingDrinks) {
            // TODO check we ordered what we are trying to serve
            // if( ... ) throw Error(EX.DRINKS_NOT_OUTSTANDING)
          } else {
            throw Error(EX.DRINKS_NOT_OUTSTANDING);
          }

          return {
            events: [{ id: EVT.DRINK_SERVED, payload }]
          };
        },
        error => {
          console.log("# Error sending command:", error);
        }
      );

      tabAggregate.setEventHandler(EVT.DRINK_SERVED, (topicState, payload) => {
        const nextOutstandingDrinks = topicState.outstandingDrinks.filter(
          drink => !payload.menuNumbers.includes(drink.menuNumber)
        );
        const temp = topicState.outstandingDrinks.filter(drink =>
          payload.menuNumbers.includes(drink.menuNumber)
        );
        const servedItemsValue = temp.reduce(
          (acc, curr) => acc + curr.price,
          0
        );
        return {
          proposal: {
            ...topicState, // TODO no, only partial, mutate!
            servedItemsValue:
              (topicState.servedItemsValue || 0) + servedItemsValue,
            outstandingDrinks: nextOutstandingDrinks
          }
        };
      });

      tabAggregate.setCommandHandler(
        CMD.MARK_FOOD_SERVED,
        (topicState, payload) => {
          if (!topicState.open) throw Error(EX.TAB_NOT_OPEN);

          if (topicState.outstandingFood) {
            // TODO check we ordered what we are trying to serve
            // if( ... ) throw Error(EX.DRINKS_NOT_OUTSTANDING)
          } else {
            throw Error(EX.FOOD_NOT_OUTSTANDING);
          }

          return {
            events: [{ id: EVT.FOOD_SERVED, payload }]
          };
        }
      );

      tabAggregate.setEventHandler(EVT.FOOD_SERVED, (topicState, payload) => {
        const nextOutstandingFood = topicState.outstandingFood.filter(
          food => !payload.menuNumbers.includes(food.menuNumber)
        );
        const temp = topicState.outstandingFood.filter(food =>
          payload.menuNumbers.includes(food.menuNumber)
        );
        const servedItemsValue = temp.reduce(
          (acc, curr) => acc + curr.price,
          0
        );

        return {
          proposal: {
            ...topicState, // TODO no, only partial, mutate!
            servedItemsValue:
              (topicState.servedItemsValue || 0) + servedItemsValue,
            outstandingFood: nextOutstandingFood
          }
        };
      });

      tabAggregate.setCommandHandler(
        CMD.CLOSE_TAB,
        (topicState, { id, amountPaid }) => {
          const orderValue = topicState.servedItemsValue;
          const tip = amountPaid - orderValue;
          return {
            events: [
              {
                id: EVT.TAB_CLOSED,
                payload: { id: 0, amountPaid, orderValue, tip }
              }
            ]
          };
        }
      );

      // --------------------------------------- //
      // --------------------------------------- //
      // --------------------------------------- //

      tabAggregate.sendCommand(CMD.OPEN_TAB, { id: 0, table: 1, waiter: 1 });

      const foodSample = {
        menuNumber: 10,
        description: "Hamburguesa",
        isDrink: false,
        price: 15
      };
      const drinkSample = {
        menuNumber: 20,
        description: "Zero Coke",
        isDrink: true,
        price: 3
      };
      const orderSample = {
        id: 1,
        orderedItems: [foodSample, drinkSample]
      };

      setTimeout(() => {
        tabAggregate.sendCommand(CMD.PLACE_ORDER, orderSample);
      }, 500);

      setTimeout(() => {
        tabAggregate.sendCommand(CMD.MARK_DRINK_SERVED, {
          id: 0,
          menuNumbers: [20]
        });
        tabAggregate.sendCommand(CMD.MARK_FOOD_SERVED, {
          id: 0,
          menuNumbers: [10]
        });
      }, 1000);

      setTimeout(() => {
        tabAggregate.sendCommand(CMD.CLOSE_TAB, { id: 0, amountPaid: 20 });
      }, 1500);
    })();
  </script>

  <body>
    <button onclick="login()">Login</button>
    <pre style="font-size: 8px;" id="root"></pre>
  </body>
</html>
